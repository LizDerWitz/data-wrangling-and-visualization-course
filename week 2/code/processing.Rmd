---
title: "Evaluations of positive and negative stimuli using the Affective Misattribution Procedure (AMP) and self-reports"
subtitle: "Data processing"
author: "Template: Ian Hussey; content: Lisa Hernandez"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}

knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

```

# assignment
# <-
# =


# Dependencies

```{r}

library(dplyr)
library(tidyr)
library(readr)
library(janitor) # for clean_names()
library(stringr)

```

# Get data

```{r}

# demographics
data_demographics_raw_messy <- read_csv("../data/raw/data_demographics_raw_messy.csv", skip = 2) |>
  janitor::clean_names()

data_demographics_raw <- read_csv("../data/raw/data_demographics_raw.csv") |>
  janitor::clean_names()

# self report measure
data_selfreport_raw <- read_csv("../data/raw/data_selfreport_raw.csv") |>
  janitor::clean_names()

```

# Demographics

Clean the demographics data so that summaries of age and gender can be made in the analysis.

```{r}

# dat_age_gender <- data_demographics_raw %>%
  # select(subject, trialcode, response) %>%
# rename(unique_id = subject, item = trialcode, response = response)

dat_age_gender <- data_demographics_raw %>%
  select(subject, trialcode, response) %>%
rename(unique_id = subject, item = trialcode, response = response)

#Temp <- data_age_gender %>%
  #filter(item == "age")

Temp1 <- dat_age_gender %>%
  filter(item == "age")

#flexible ways of "string matching"
#temp <- data_age_gender |>
  #filter(item %in% c("age", "Age", "AGE")) / Any item of this vector

#to wrangle the demographics out of the raw 
dat_age_gender <- data_demographics_raw %>%
#select useful columns
select(subject, trialcode, response) %>%
#rename
rename(unique_id = subject, item = trialcode, response = response) %>%
#retain rows that we need 
filter(item == "age")
  
temp1 <- dat_age_gender %>%
  distinct(response)

temp2 <- dat_age_gender |>
  #mutate allows you to create or change variables
  mutate(unique_id_2 = unique_id * 2) %>%
  filter(item != "gender") 
#so we only have gender
library(stringr)
library(dplyr)

temp2 <- dat_age_gender |>
  mutate(response = str_remove_all(response, "[\\D]), response = no_if(response,""))

#Homework

dat_age_gender <- data_demographics_raw %>%
+   select(subject, trialcode, response) %>%
+ rename(unique_id = subject, item = trialcode, response = response)

Temp1 <- dat_age_gender %>%
  filter(item == "gender")
         
F1 <- Temp1 %>%
rename(unique_id = unique_id, item = item, gender = response)

-> hai rinominato la colonna gender

 F2 <- F1 %>%
 mutate(gender = str_remove_all(gender, "[0-9]"), gender = na_if(gender, ""))
         
         -> ora il numero Ã¨ in NA 

F1$gender[F1$gender == "yes"] <- NA

mutate(response)

F3 <- F2 %>%
mutate(gender = str_trim (tolower(gender)))

#everything to lower cases

F4 <- F3 %>%
mutate(gender = replace(gender, !(gender %in% c("men","woman","male","female","non-binary","non binary")), NA_character_))

#exclusion of characters we don't need, we just specified what we want included

F5 <- F4 %>%
mutate(gender = ifelse(gender == "woman","female", gender))
 
# ora si chiamano tutte le donne, female

F6 <- F5 %>%
mutate(gender = ifelse(gender == "non binary","non-binary", gender))


#Homework final coding

dat_age_gender <- data_demographics_raw %>%
select(subject, trialcode, response) %>%
rename(unique_id = subject, item = trialcode, gender = response)%>%
filter(item == "gender") %>%
mutate(gender = str_remove_all(gender, "[0-9]"), gender = na_if(gender, "")) %>%
mutate(gender = str_trim (tolower(gender))) %>%
mutate(gender = replace(gender, !(gender %in% c("men","woman","male","female","non-binary","non binary")), NA_character_)) %>%
mutate(gender = ifelse(gender == "woman","female", gender)) %>%
mutate(gender = ifelse(gender == "non binary","non-binary", gender))

# Exclusions / data quality

## AMP

Create an exclusion variable `exclude_amp_performance` based on AMP performance: "exclude" if more than 10% of trials are < 100ms, or "include" if not.

Create an exclusion variable `exclude_amp_completeness` based on the AMP having the right number of trials.

```{r}

#data_amp_performance_criteria <- data_amp_raw 

```

# Self-reports

Create a mean score for each participant of the three self-report items.

```{r}

#data_selfreport_trial_level <- data_selfreport_raw 

```

# Affect Misattribution Procedure

Create an overall AMP bias score. Score each trial as having been evalauted as congruent with the prime or not. eg When trialcode == "prime_positive" & evaluative_response == 1, then record as 1, etc. AMP score is the proportion of congruent responses.

```{r}

#data_amp_score_congruence <- data_amp_raw 

```

# Combine 

Combine data frames together to create one wide-format data frame where each row represents a participant.

Flag all duplicates for exclusion.

```{r}

# data_processed_before_exclusions 

```

# Define master exclusion variable

```{r}

#data_processed <- data_processed_before_exclusions

```

# Write to disk

```{r}

# # in case this dir doesn't exist, create it
# dir.create("../data/processed/")
# 
# # save data to disk in that dir
# write_csv(data_processed, "../data/processed/data_processed.csv")

```

# Session info

```{r}

sessionInfo()

```


